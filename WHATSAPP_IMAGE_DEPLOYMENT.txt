# ðŸš€ WHATSAPP IMAGE SENDER DEPLOYMENT
# MongoDB Vector Search + Actual Image Sending via WhatsApp Webhook
# Deploy this enhanced system that sends real product images

# ============================================================================
# COPY ENHANCED SYSTEM WITH IMAGE SENDING
# ============================================================================

# Copy vector search system
docker cp gemini_vector_search.py watchvine_main_app:/app/gemini_vector_search.py
docker cp enhanced_backend_tool_classifier.py watchvine_main_app:/app/enhanced_backend_tool_classifier.py

# Copy WhatsApp image sender
docker cp whatsapp_image_sender.py watchvine_main_app:/app/whatsapp_image_sender.py

# Copy updated agent orchestrator with image handling
docker cp agent_orchestrator.py watchvine_main_app:/app/agent_orchestrator.py

# ============================================================================
# SET ENVIRONMENT VARIABLES FOR WHATSAPP API
# ============================================================================

# Set WhatsApp API credentials (replace with your actual values)
docker exec watchvine_main_app bash -c 'export WHATSAPP_API_TOKEN="your_whatsapp_business_api_token"'
docker exec watchvine_main_app bash -c 'export WHATSAPP_WEBHOOK_URL="https://graph.facebook.com/v17.0/your_phone_number_id/messages"'

# OR set custom webhook URL
docker exec watchvine_main_app bash -c 'export CUSTOM_WEBHOOK_URL="https://your-webhook-url.com/send-images"'

# ============================================================================
# RESTART AND INITIALIZE SYSTEM
# ============================================================================

# Restart container
docker restart watchvine_main_app
sleep 20

# Initialize vector embeddings
docker exec watchvine_main_app python -c "
from gemini_vector_search import GeminiVectorSearch
search = GeminiVectorSearch('mongodb://admin:strongpassword123@72.62.76.36:27017/?authSource=admin', 'AIzaSyBZ8shurgeNDiDj4TlpBk7RUgrQ-G2mJ_0')
print('ðŸ”„ Creating vector embeddings...')
search.index_products(batch_size=20)
print('âœ… Vector indexing complete!')
search.close()
"

# ============================================================================
# TEST THE IMAGE SENDING SYSTEM
# ============================================================================

# Test vector search with image sending
docker exec watchvine_main_app python -c "
from agent_orchestrator import AgentOrchestrator
orchestrator = AgentOrchestrator()

# Test product search
result = orchestrator.process_message(
    conversation_history=[],
    user_message='mane rolex watch black ma joi e',
    phone_number='+1234567890'  # Test phone number
)

print(f'âœ… Test result: {result.get(\"tool_used\", \"unknown\")}')
print(f'ðŸ“± Images sent: {result.get(\"images_sent\", False)}')
print(f'ðŸ“Š Products: {result.get(\"products_count\", 0)}')
"

# ============================================================================
# VERIFY SYSTEM HEALTH
# ============================================================================

# Check main app health
docker exec watchvine_main_app curl -f http://localhost:8000/health

# Test the enhanced system
docker exec watchvine_main_app python -c "
from enhanced_backend_tool_classifier import BackendToolClassifier
classifier = BackendToolClassifier()

# Test different query types
queries = [
    'mane rolex watch black ma joi e',  # Product search
    'show me luxury watches',          # Product search  
    'hi how are you'                   # General chat
]

for query in queries:
    result = classifier.classify_and_search(query)
    tool = result.get('tool', 'unknown')
    print(f'Query: \"{query}\" -> Tool: {tool}')

classifier.close()
print('âœ… System working correctly!')
"

# ============================================================================
# MONITOR LOGS
# ============================================================================

# Watch logs for image sending
docker logs -f watchvine_main_app

# ============================================================================
# EXPECTED WORKFLOW AFTER DEPLOYMENT
# ============================================================================

# ðŸ”„ NEW ENHANCED WORKFLOW:
# 1. User sends: "mane rolex watch black ma joi e"
# 2. Backend classifier enhances to: "I want black Rolex watch"  
# 3. Vector search finds matching Rolex watches
# 4. System sends ACTUAL IMAGES via WhatsApp with:
#    - Product image (not URL)
#    - Caption: "Brand - Name, Price: â‚¹XXX, Shop: URL"
# 5. User receives real product images in WhatsApp

# ðŸ“± WhatsApp Response Format:
# [IMAGE 1: Rolex Submariner]
# Caption: "*Rolex - Submariner Black*
#          ðŸ’° Price: â‚¹5999  
#          ðŸ”— Shop: https://watchvine01.cartpe.in/..."
#
# [IMAGE 2: Rolex GMT Master] 
# Caption: "*Rolex - GMT Master*
#          ðŸ’° Price: â‚¹6499
#          ðŸ”— Shop: https://watchvine01.cartpe.in/..."

# âœ… Features Working:
# - Hinglish query understanding
# - MongoDB vector search with Gemini embeddings  
# - Actual image sending (not URLs)
# - Product info in image captions
# - Fallback to text if image sending fails
# - General chat vs product search classification

# ðŸŽ‰ DEPLOYMENT COMPLETE! WhatsApp now sends real product images! ðŸŽ‰